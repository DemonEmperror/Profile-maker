<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Resume</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .profile-name {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .profile-content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: 12px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .section:hover {
            background: #f1f5f9;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
        }

        .section-content {
            overflow: hidden;
        }

        .field {
            margin-bottom: 1.5rem;
            position: relative;
        }

        label {
            font-weight: 600;
            color: #374151;
            display: block;
            margin-bottom: 0.5rem;
        }

        .editable {
            width: 100%;
            padding: 12px;
            min-height: 40px;
            font-size: 15px;
            outline: none;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .editable:focus {
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.3);
        }

        .field-group {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 3px solid #10b981;
        }

        .format-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .format-button:hover {
            background: #1e40af;
        }

        .action-buttons {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            margin: 2rem -2rem -2rem;
            border-radius: 0 0 20px 20px;
        }

        .action-buttons button {
            background: white;
            color: #059669;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            margin: 0 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .action-buttons button:hover {
            background: #f0fdf4;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .modal, .format-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content, .format-modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .format-modal-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .format-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f3f2f1;
            border-radius: 4px;
        }

        .format-toolbar button {
            background: none;
            border: none;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }

        .format-toolbar button:hover {
            background: #e1dfdd;
        }

        .format-editor {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            font-size: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        .format-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .format-actions button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .format-actions .save {
            background: #10b981;
            color: white;
        }

        .format-actions .cancel {
            background: #ef4444;
            color: white;
        }

        .suggestion {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
        }

        .suggestion:last-child {
            border-bottom: none;
        }

        .suggestion p {
            margin: 0.5rem 0;
        }

        .suggestion button {
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .suggestion .accept {
            background: #10b981;
            color: white;
        }

        .suggestion .reject {
            background: #ef4444;
            color: white;
        }

        @media (max-width: 768px) {
            .profile-container {
                margin: 1rem;
            }
            .profile-name {
                font-size: 1.8rem;
            }
            .profile-content {
                padding: 1rem;
            }
            .section {
                padding: 1rem;
            }
            .action-buttons button {
                width: 100%;
                margin: 0.5rem 0;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .profile-container {
                box-shadow: none;
                border-radius: 0;
            }
            .profile-header {
                background: #1e40af !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .action-buttons, .modal, .format-modal, .format-button {
                display: none;
            }
            .editable {
                border: none;
                background: transparent;
                padding: 0;
                width: auto;
                display: inline-block;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <h1 class="profile-name">Professional Resume</h1>
        </div>
        <div class="profile-content">
            <form id="profile-form" method="POST" action="/update_profile">
                <input type="hidden" name="profile_data" value='{{ profile | tojson | safe }}'>

                <div class="section">
                    <h2 class="section-title">Name</h2>
                    <div id="name-section" class="section-content">
                        <div class="field">
                            <label for="name">Name:</label>
                            <div class="editable" id="name" contenteditable="true" spellcheck="true">{{ profile.get('name', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('name')">Format</button>
                            <input type="hidden" id="name_hidden" name="name">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Education, Training, and Certifications</h2>
                    <div id="education-section" class="section-content">
                        <div id="education_training_certifications">
                            {% for item in profile.get('education_training_certifications', []) %}
                                <div class="field">
                                    <div class="editable" id="etc_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ item | safe }}</div>
                                    <button type="button" class="format-button" onclick="openFormatModal('etc_{{ loop.index0 }}')">Format</button>
                                    <input type="hidden" name="education_training_certifications[]" id="etc_{{ loop.index0 }}_hidden">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Total Experience</h2>
                    <div id="experience-section" class="section-content">
                        <div class="field">
                            <label for="total_experience">Total Experience:</label>
                            <div class="editable" id="total_experience" contenteditable="true" spellcheck="true">{{ profile.get('total_experience', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('total_experience')">Format</button>
                            <input type="hidden" id="total_experience_hidden" name="total_experience">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Professional Summary</h2>
                    <div id="summary-section" class="section-content">
                        <div class="field">
                            <label for="professional_summary">Summary:</label>
                            <div class="editable" id="professional_summary" contenteditable="true" spellcheck="true">{{ profile.get('professional_summary', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('professional_summary')">Format</button>
                            <input type="hidden" id="professional_summary_hidden" name="professional_summary">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">NetWeb Projects</h2>
                    <div id="netweb-projects-section" class="section-content">
                        <div id="netweb_projects">
                            {% for project in profile.get('netweb_projects', []) %}
                                <div class="field field-group" id="netweb_project_{{ loop.index0 }}">
                                    <label>Title:</label>
                                    <div class="editable" id="netweb_title_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ project.get('title', '') | safe }}</div>
                                    <button type="button" class="format-button" onclick="openFormatModal('netweb_title_{{ loop.index0 }}')">Format</button>
                                    <input type="hidden" name="netweb_projects[title][]" id="netweb_title_{{ loop.index0 }}_hidden">
                                    <label>Description:</label>
                                    <div class="editable" id="netweb_desc_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ project.get('description', '') | safe }}</div>
                                    <button type="button" class="format-button" onclick="openFormatModal('netweb_desc_{{ loop.index0 }}')">Format</button>
                                    <input type="hidden" name="netweb_projects[description][]" id="netweb_desc_{{ loop.index0 }}_hidden">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Past Projects</h2>
                    <div id="past-projects-section" class="section-content">
                        <div id="past_projects">
                            {% for project in profile.get('past_projects', []) %}
                                <div class="field field-group" id="past_project_{{ loop.index0 }}">
                                    <label>Title:</label>
                                    <div class="editable" id="past_title_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ project.get('title', '') | safe }}</div>
                                    <button type="button" class="format-button" onclick="openFormatModal('past_title_{{ loop.index0 }}')">Format</button>
                                    <input type="hidden" name="past_projects[title][]" id="past_title_{{ loop.index0 }}_hidden">
                                    <label>Description:</label>
                                    <div class="editable" id="past_desc_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ project.get('description', '') | safe }}</div>
                                    <button type="button" class="format-button" onclick="openFormatModal('past_desc_{{ loop.index0 }}')">Format</button>
                                    <input type="hidden" name="past_projects[description][]" id="past_desc_{{ loop.index0 }}_hidden">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Roles and Responsibilities</h2>
                    <div id="roles-section" class="section-content">
                        <div class="field">
                            <label for="roles_responsibilities">Roles:</label>
                            <div class="editable" id="roles_responsibilities" contenteditable="true" spellcheck="true">{{ profile.get('roles_responsibilities', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('roles_responsibilities')">Format</button>
                            <input type="hidden" id="roles_responsibilities_hidden" name="roles_responsibilities">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Technical Skills</h2>
                    <div id="skills-section" class="section-content">
                        <div class="field">
                            <label>Web Technologies:</label>
                            <div id="technical_skills_web_technologies">
                                {% for skill in profile.get('technical_skills', {}).get('web_technologies', []) %}
                                    <div class="field">
                                        <div class="editable" id="web_tech_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('web_tech_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[web_technologies][]" id="web_tech_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="field">
                            <label>Scripting Languages:</label>
                            <div id="technical_skills_scripting_languages">
                                {% for skill in profile.get('technical_skills', {}).get('scripting_languages', []) %}
                                    <div class="field">
                                        <div class="editable" id="script_lang_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('script_lang_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[scripting_languages][]" id="script_lang_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="field">
                            <label>Frameworks:</label>
                            <div id="technical_skills_frameworks">
                                {% for skill in profile.get('technical_skills', {}).get('frameworks', []) %}
                                    <div class="field">
                                        <div class="editable" id="framework_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('framework_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[frameworks][]" id="framework_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="field">
                            <label>Databases:</label>
                            <div id="technical_skills_databases">
                                {% for skill in profile.get('technical_skills', {}).get('databases', []) %}
                                    <div class="field">
                                        <div class="editable" id="database_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('database_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[databases][]" id="database_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="field">
                            <label>Web Servers:</label>
                            <div id="technical_skills_web_servers">
                                {% for skill in profile.get('technical_skills', {}).get('web_servers', []) %}
                                    <div class="field">
                                        <div class="editable" id="web_server_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('web_server_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[web_servers][]" id="web_server_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="field">
                            <label>Tools:</label>
                            <div id="technical_skills_tools">
                                {% for skill in profile.get('technical_skills', {}).get('tools', []) %}
                                    <div class="field">
                                        <div class="editable" id="tool_{{ loop.index0 }}" contenteditable="true" spellcheck="true">{{ skill | safe }}</div>
                                        <button type="button" class="format-button" onclick="openFormatModal('tool_{{ loop.index0 }}')">Format</button>
                                        <input type="hidden" name="technical_skills[tools][]" id="tool_{{ loop.index0 }}_hidden">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Personal Details</h2>
                    <div id="personal-details-section" class="section-content">
                        <div class="field">
                            <label for="employee_id">Employee ID:</label>
                            <div class="editable" id="employee_id" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('employee_id', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('employee_id')">Format</button>
                            <input type="hidden" id="employee_id_hidden" name="personal_details[employee_id]">
                        </div>
                        <div class="field">
                            <label for="permanent_address">Permanent Address:</label>
                            <div class="editable" id="permanent_address" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('permanent_address', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('permanent_address')">Format</button>
                            <input type="hidden" id="permanent_address_hidden" name="personal_details[permanent_address]">
                        </div>
                        <div class="field">
                            <label for="local_address">Local Address:</label>
                            <div class="editable" id="local_address" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('local_address', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('local_address')">Format</button>
                            <input type="hidden" id="local_address_hidden" name="personal_details[local_address]">
                        </div>
                        <div class="field">
                            <label for="contact_number">Contact Number:</label>
                            <div class="editable" id="contact_number" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('contact_number', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('contact_number')">Format</button>
                            <input type="hidden" id="contact_number_hidden" name="personal_details[contact_number]">
                        </div>
                        <div class="field">
                            <label for="date_of_joining">Date of Joining:</label>
                            <div class="editable" id="date_of_joining" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('date_of_joining', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('date_of_joining')">Format</button>
                            <input type="hidden" id="date_of_joining_hidden" name="personal_details[date_of_joining]">
                        </div>
                        <div class="field">
                            <label for="designation">Designation:</label>
                            <div class="editable" id="designation" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('designation', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('designation')">Format</button>
                            <input type="hidden" id="designation_hidden" name="personal_details[designation]">
                        </div>
                        <div class="field">
                            <label for="overall_experience">Overall Experience:</label>
                            <div class="editable" id="overall_experience" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('overall_experience', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('overall_experience')">Format</button>
                            <input type="hidden" id="overall_experience_hidden" name="personal_details[overall_experience]">
                        </div>
                        <div class="field">
                            <label for="date_of_birth">Date of Birth:</label>
                            <div class="editable" id="date_of_birth" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('date_of_birth', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('date_of_birth')">Format</button>
                            <input type="hidden" id="date_of_birth_hidden" name="personal_details[date_of_birth]">
                        </div>
                        <div class="field">
                            <label for="passport_details">Passport Details:</label>
                            <div class="editable" id="passport_details" contenteditable="true" spellcheck="true">{{ profile.get('personal_details', {}).get('passport_details', '') | safe }}</div>
                            <button type="button" class="format-button" onclick="openFormatModal('passport_details')">Format</button>
                            <input type="hidden" id="passport_details_hidden" name="personal_details[passport_details]">
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" onclick="checkGrammar()">Check Grammar</button>
                    <button type="submit" name="action" value="save">Save Profile Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="grammarModal" class="modal">
        <div class="modal-content">
            <h3>Grammar Suggestions</h3>
            <div id="suggestions"></div>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <div id="formatModal" class="format-modal">
        <div class="format-modal-content">
            <h3>Format Text</h3>
            <div class="format-toolbar">
                <button type="button" onclick="formatModalText('bold')"><b>B</b></button>
                <button type="button" onclick="formatModalText('italic')"><i>I</i></button>
                <button type="button" onclick="formatModalText('underline')"><u>U</u></button>
                <button type="button" onclick="formatModalText('insertUnorderedList')">• List</button>
                <button type="button" onclick="formatModalText('insertOrderedList')">1. List</button>
            </div>
            <div class="format-editor" id="formatEditor" contenteditable="true"></div>
            <div class="format-actions">
                <button class="save" onclick="saveFormatChanges()">Save</button>
                <button class="cancel" onclick="closeFormatModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentFieldId = '';

        // Initialize hidden fields on page load
        window.addEventListener('load', () => {
            updateAllHiddenFields();
            setupEditableFields();
        });

        // Update all hidden fields before form submission
        document.getElementById('profile-form').addEventListener('submit', function(event) {
            console.log('Form submission started');
            updateProjectDescriptions('netweb');
            updateProjectDescriptions('past');
            updateAllHiddenFields();
            const formData = new FormData(this);
            for (let [key, value] of formData.entries()) {
                console.log(`Form data: ${key}=${value}`);
            }
        });

        function openFormatModal(fieldId) {
            currentFieldId = fieldId;
            const field = document.getElementById(fieldId);
            const editor = document.getElementById('formatEditor');
            editor.innerHTML = field.innerHTML;
            document.getElementById('formatModal').style.display = 'flex';
            editor.focus();
        }

        function closeFormatModal() {
            document.getElementById('formatModal').style.display = 'none';
            currentFieldId = '';
            document.getElementById('formatEditor').innerHTML = '';
        }

        function formatModalText(command) {
            const editor = document.getElementById('formatEditor');
            document.getSelection().selectAllChildren(editor);
            document.execCommand(command, false, null);
            editor.focus();
            
            // Immediately update the original field
            if (currentFieldId) {
                const field = document.getElementById(currentFieldId);
                field.innerHTML = editor.innerHTML;
                field.dispatchEvent(new Event('input'));
                updateHiddenField(currentFieldId);
                if (currentFieldId.includes('_desc_') || currentFieldId.includes('_title_')) {
                    updateProjectDescriptions(currentFieldId.split('_')[0]);
                }
            }
        }

        function saveFormatChanges() {
            if (currentFieldId) {
                const editor = document.getElementById('formatEditor');
                const field = document.getElementById(currentFieldId);
                field.innerHTML = editor.innerHTML;
                field.dispatchEvent(new Event('input'));
                updateHiddenField(currentFieldId);
                if (currentFieldId.includes('_desc_') || currentFieldId.includes('_title_')) {
                    updateProjectDescriptions(currentFieldId.split('_')[0]);
                }
                closeFormatModal();
            }
        }

        function updateProjectDescriptions(type) {
            const containers = document.querySelectorAll(`#${type}_projects .field-group`);
            containers.forEach((container, projectIndex) => {
                const titleEditable = document.getElementById(`${type}_title_${projectIndex}`);
                const titleHidden = document.getElementById(`${type}_title_${projectIndex}_hidden`);
                if (titleEditable && titleHidden) {
                    titleHidden.value = titleEditable.innerHTML.trim();
                    console.log(`Updated ${type}_title_${projectIndex}_hidden:`, titleHidden.value);
                }
                const descEditable = document.getElementById(`${type}_desc_${projectIndex}`);
                const descHidden = document.getElementById(`${type}_desc_${projectIndex}_hidden`);
                if (descEditable && descHidden) {
                    descHidden.value = descEditable.innerHTML.trim();
                    console.log(`Updated ${type}_desc_${projectIndex}_hidden:`, descHidden.value);
                }
            });
        }

        function updateHiddenField(elementId) {
            const editable = document.getElementById(elementId);
            const hiddenInput = document.getElementById(`${elementId}_hidden`);
            if (editable && hiddenInput) {
                hiddenInput.value = editable.innerHTML.trim();
                console.log(`Updated ${elementId}_hidden:`, hiddenInput.value);
            }
        }

        function updateAllHiddenFields() {
            const fields = [
                'name', 'total_experience', 'professional_summary', 'roles_responsibilities',
                'employee_id', 'permanent_address', 'local_address', 'contact_number',
                'date_of_joining', 'designation', 'overall_experience', 'date_of_birth',
                'passport_details'
            ];
            fields.forEach(field => updateHiddenField(field));

            document.querySelectorAll('[id^=etc_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=web_tech_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=script_lang_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=framework_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=database_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=web_server_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=tool_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=netweb_title_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=past_title_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=netweb_desc_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });

            document.querySelectorAll('[id^=past_desc_][id$=_hidden]').forEach(hidden => {
                const id = hidden.id.replace('_hidden', '');
                updateHiddenField(id);
            });
        }

        function setupEditableFields() {
            const fields = [
                'name', 'total_experience', 'professional_summary', 'roles_responsibilities',
                'employee_id', 'permanent_address', 'local_address', 'contact_number',
                'date_of_joining', 'designation', 'overall_experience', 'date_of_birth',
                'passport_details'
            ];
            fields.forEach(field => {
                const editable = document.getElementById(field);
                if (editable) {
                    editable.addEventListener('input', () => updateHiddenField(field));
                }
            });

            document.querySelectorAll('[id^=etc_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=web_tech_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=script_lang_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=framework_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=database_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=web_server_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=tool_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateHiddenField(editable.id));
                }
            });

            document.querySelectorAll('[id^=netweb_title_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateProjectDescriptions('netweb'));
                }
            });

            document.querySelectorAll('[id^=past_title_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateProjectDescriptions('past'));
                }
            });

            document.querySelectorAll('[id^=netweb_desc_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateProjectDescriptions('netweb'));
                }
            });

            document.querySelectorAll('[id^=past_desc_]').forEach(editable => {
                if (!editable.id.endsWith('_hidden')) {
                    editable.addEventListener('input', () => updateProjectDescriptions('past'));
                }
            });
        }

        function checkGrammar() {
            const form = document.getElementById('profile-form');
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (key.includes('[]') || key.includes('[title]') || key.includes('[description]') || key.includes('personal_details')) {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }

            fetch('/check_grammar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(suggestions => {
                displaySuggestions(suggestions);
            })
            .catch(error => {
                console.error('Error checking grammar:', error);
                alert('Failed to check grammar. Please try again.');
            });
        }

        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            if (suggestions.length === 0) {
                suggestionsDiv.innerHTML = '<p>No grammar issues found.</p>';
            } else {
                suggestions.forEach((suggestion, index) => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'suggestion';
                    suggestionDiv.innerHTML = `
                        <p><strong>Field:</strong> ${suggestion.field}</p>
                        <p><strong>Original:</strong> ${suggestion.original}</p>
                        <p><strong>Suggested:</strong> ${suggestion.suggested}</p>
                        <p><strong>Reason:</strong> ${suggestion.reason}</p>
                        <button class="accept" onclick="applySuggestion('${suggestion.field_id}', '${suggestion.suggested.replace(/'/g, "\\'")}')">Accept</button>
                        <button class="reject" onclick="this.parentElement.remove()">Reject</button>
                    `;
                    suggestionsDiv.appendChild(suggestionDiv);
                });
            }
            document.getElementById('grammarModal').style.display = 'flex';
        }

        function applySuggestion(fieldId, suggestedText) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.innerHTML = suggestedText;
                field.dispatchEvent(new Event('input')); // Trigger input event for reactivity
                const suggestionDiv = document.querySelector(`.suggestion button[onclick*="applySuggestion('${fieldId}'"]`).parentElement;
                suggestionDiv.remove();
                if (!document.querySelector('.suggestion')) {
                    document.getElementById('grammarModal').style.display = 'none';
                }
                updateHiddenField(fieldId);
                if (fieldId.includes('_desc_') || fieldId.includes('_title_')) {
                    updateProjectDescriptions(fieldId.split('_')[0]);
                }
            }
        }

        function closeModal() {
            document.getElementById('grammarModal').style.display = 'none';
        }
    </script>
</body>
</html>